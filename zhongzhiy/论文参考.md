# Hayagriva

[![Build status](https://github.com/typst/hayagriva/workflows/Continuous%20integration/badge.svg)](https://github.com/typst/hayagriva/actions)
[![Current crates.io release](https://img.shields.io/crates/v/hayagriva)](https://crates.io/crates/hayagriva)
[![Documentation](https://img.shields.io/badge/docs.rs-hayagriva-66c2a5?labelColor=555555&logoColor=white&logo=data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N[...]

生而健壮的参考文献管理（Rust）。

Hayagriva 是一个可以帮助你或你的应用处理文献与其他媒体的工具。其功能包括：

- 表示文献集合的数据结构
- 从 YAML 文件读取并写入这些集合
- 按流行格式指南将文献格式化为参考文献列表条目与文内引用
- 与 BibTeX 的互操作性
- 按类型和可用元数据查询文献条目

Hayagriva 可以作为库使用，也可以作为命令行界面（CLI）使用。有关在应用中如何使用的更多信息，请跳转到“使用”一节（Usage）；若要了解如何在终端安装并使用 Hayagriva，请参阅“安装”一节（Installation）。

## 支持的样式

Hayagriva 支持所有来自官方 Citation Style Language 仓库的样式（https://github.com/citation-style-language/styles），目前超过 2,600 种。

## 使用方法

```rust
use hayagriva::io::from_yaml_str;

let yaml = r#"
crazy-rich:
    type: Book
    title: Crazy Rich Asians
    author: Kwan, Kevin
    date: 2014
    publisher: Anchor Books
    location: New York, NY, US
"#;

// 解析参考文献
let bib = from_yaml_str(yaml).unwrap();
assert_eq!(bib.get("crazy-rich").unwrap().date().unwrap().year, 2014);

// 格式化参考条目
use std::fs;
use hayagriva::{
    BibliographyDriver, BibliographyRequest, BufWriteFormat,
    CitationItem, CitationRequest,
};
use hayagriva::citationberg::{LocaleFile, IndependentStyle};

let en_locale = fs::read_to_string("tests/data/locales-en-US.xml").unwrap();
let locales = [LocaleFile::from_xml(&en_locale).unwrap().into()];

let style = fs::read_to_string("tests/data/art-history.csl").unwrap();
let style = IndependentStyle::from_xml(&style).unwrap();

let mut driver = BibliographyDriver::new();

for entry in bib.iter() {
    let items = vec![CitationItem::with_entry(entry)];
    driver.citation(CitationRequest::from_items(items, &style, &locales));
}

let result = driver.finish(BibliographyRequest {
    style: &style,
    locale: None,
    locale_files: &locales,
});

for cite in result.citations {
    println!("{}", cite.citation.to_string())
}
```

要格式化条目，需要将它们包装到 `CitationRequest` 中。每个请求可以引用多个条目（通过各自的 `CitationItem`）。将这些请求与 `BibliographyDriver` 一起使用，可以获得格式化后的引用与参考文献列表。

你可以提供你自己的 CSL 文件，或者使用大约 100 个捆绑的引用样式（需启用 `archive` 功能）。

如果启用了默认功能，Hayagriva 支持 BibTeX 与 BibLaTeX 文献库。你可以使用 `io::from_biblatex_str` 来解析此类文献库。

如果需要更手动的控制，库的原生 `Entry` 结构也为 `From<&biblatex::Entry>` Trait 提供了实现。你需要依赖 [biblatex](https://docs.rs/biblatex/latest/biblatex/) crate 来获得其 `Entry`。因此，你也可以像下面这样使用你的 BibLaTeX 内容：

```rust
use hayagriva::Entry;
let converted: Entry = your_biblatex_entry.into();
```

如果你不需要 BibLaTeX 兼容性，可以在 `Cargo.toml` 中禁用默认功能，像这样使用 Hayagriva：

```toml
[dependencies]
hayagriva = { version = "0.9", default-features = false }
```

### 选择器（Selectors）

Hayagriva 使用一个自定义的选择器语言，允许你按媒体类型过滤文献库。有关选择器的更多信息，请参阅 [selectors.md 文件](https://github.com/typst/hayagriva/blob/main/docs/selectors.md)。虽然你可以使用函数 `Selector::parse` 解析用户定义的选择器，但当选择器为常量时，你可能更希望使用选择器宏（selector macro），以避免运行时解析选择器的开销。

```rust
use hayagriva::select;
use hayagriva::io::from_yaml_str;

let yaml = r#"
quantized-vortex:
    type: Article
    author: Gross, E. P.
    title: Structure of a Quantized Vortex in Boson Systems
    date: 1961-05
    page-range: 454-477
    doi: 10.1007/BF02731494
    parent:
        issue: 3
        volume: 20
        title: Il Nuovo Cimento
"#;

let entries = from_yaml_str(yaml).unwrap();
let journal = select!((Article["date"]) > ("journal":Periodical));
assert!(journal.matches(entries.nth(0).unwrap()));
```

有两种方法可以检查选择器是否匹配某个条目。如果你只想知道某个条目是否匹配选择器，应使用 [`Selector::matches`]；如果你想继续使用匹配条目的父条目中的数据，应使用 [`Selector::apply`]。请注意，`apply` 即便没有绑定到任何子条目 / 即使哈希映射为空，也会返回 `Some`。

## 安装

在终端运行如下命令：

```bash
cargo install hayagriva --features cli
```

Cargo 会为你安装 Hayagriva 命令行界面（CLI）。现在你只需要一个 Hayagriva YAML 文献文件或一个 Bib(La)TeX 文件即可开始使用。Hayagriva 的 YAML 文件格式易于书写，并且可以表示丰富的媒体类型，[在专门的文档中学习如何编写。](https://github.com/typst/hayagriva/blob/main/docs/file-format.md)

假设你在当前工作目录下保存了如下文件 `literature.yaml`：

```yaml
dependence:
    type: Article
    title: The program dependence graph and its use in optimization
    author: ["Ferrante, Jeanne", "Ottenstein, Karl J.", "Warren, Joe D."]
    date: 1987-07
    serial-number:
        doi: "10.1145/24039.24041"
    parent:
        type: Periodical
        title: ACM Transactions on Programming Languages and Systems
        volume: 9
        issue: 3

feminism:
    type: Article
    title: She swoons to conquer
    author: Ungard-Sargon, Batya
    editor: Weintraub, Pam
    date: 2015-09-25
    url: https://aeon.co/essays/can-you-enjoy-romance-fiction-and-be-a-feminist
    parent:
        type: Blog
        title: Aeon
```

然后你可以运行以下命令来获取这两篇文章的参考文献列表条目：

```bash
hayagriva literature.yaml reference
```

Hayagriva 默认为芝加哥手册（第 17 版）作者-日期（Author-Date）样式。如果你想使用其他样式，例如美国心理学会（APA）样式，可以像下面这样指定：

```bash
hayagriva literature.yaml reference --style apa
```

`--style` 参数可接受的值可以通过运行 `hayagriva help reference` 来查看。

如果你现在需要第二篇文章的文内引用，可以运行：

```bash
hayagriva literature.yaml cite --key feminism
```

`--key` 接受逗号分隔的键列表（或单个键）。该子命令只会对指定的键工作。与 `reference` 子命令类似，`cite` 命令也允许 `--style` 参数。其可接受的值可通过 `hayagriva help cite` 查看。默认样式为作者-日期（Author-Date）。

你也可以使用 `--select` 提供自定义的 Hayagriva 选择器（参见 [选择器文档](https://github.com/typst/hayagriva/blob/main/docs/selectors.md)）。例如，你可以运行下面的命令只参考在顶层具有 URL 或 DOI 的条目：

```bash
hayagriva literature.yaml --select "*[url] | *[doi]" reference
```

这个表达式会匹配示例中的两个条目，因此该命令会返回与第一个 reference 命令相同的结果。

Hayagriva 还允许你查看当选择器匹配时，哪些值被绑定到了哪些子条目。这在你将 Hayagriva 作为依赖并需要调试表达式时尤其有用。考虑这个选择器，它总是将包含 volume 字段的子条目绑定为 `a`，无论它是出现在顶层还是在第一个父条目中：`a:*[volume] | * > a:[volume]`。然后你可以使用下面的命令来显示选择器为每个匹配绑定为 `a` 的子条目：

```bash
hayagriva literature.yaml --select "a:*[volume] | * > a:[volume]" --show-bound
```

`--show-bound` 标志会显示与选择器或键过滤器匹配的所有键，并说明每个条目中哪些子条目被选择器绑定。如果你只想获取匹配键的列表，请使用 `--keys` 标志。

如果你正在处理 BibTeX，可以像使用 `.yaml`/`.yml` 文件那样在 Hayagriva 中使用你的 `.bib` 文件。如果你想将 `.bib` 文件转换为 `.yaml` 文件，只需将 `.bib` 文件传给 CLI，而不带额外参数。它会在标准输出上显示带有键和选择器过滤后的 YAML 格式文献库。若要将 `.bib` 文件转换并另存为文件，可以使用重定向 `>`：

```bash
hayagriva literature.bib > converted.yaml
```

## 贡献

我们期待在 Issues 选项卡中收到你的 bug 报告与功能请求。我们也非常欢迎对以下内容发起 PR：修复 bug、少量重构、在 Issues 中已提出并由我们批准的功能，以及下面列出的计划中功能：

- 实现 YAML 到 BibLaTeX 的转换
- 文档改进
- CSL 修复
- CSL-M 支持

感谢每一位潜在贡献者为本项目所付出的努力以及对本项目的采用！

## 许可证

Hayagriva 采用 MIT / Apache 2.0 双重许可。

库的使用者可以在这两种许可证中选择其希望适用的一种，而贡献者必须接受其代码在遵守这两种许可证条款下进行分发。

如果启用了 `archive` 功能，Hayagriva 包含的 CSL 样式在许可上为 CC-BY-SA 3.0 Deed。文件 `styles.cbor.rkyv` 是这些作品的集合，并适用该许可。可以通过反序列化该文件（使用 `styles` 函数）并读取 `StyleInfo` 结构来检索署名信息。