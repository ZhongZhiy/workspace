å¥½çš„ ğŸ˜Š  
ä½ ç°åœ¨å·²ç»ç†è§£äº† make çš„â€œè¯­è¨€æ ¸å¿ƒâ€ï¼ˆè§„åˆ™ã€å˜é‡ã€ä¾èµ–ç­‰ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ­£å¼è¿›å…¥ **Makefile é«˜çº§è¯­æ³•** çš„ä¸–ç•Œã€‚

è¿™äº›å†…å®¹è®© Makefile ä¸åªæ˜¯â€œç¼–è¯‘å·¥å…·â€ï¼Œè€Œæ˜¯ä¸€ä¸ªèƒ½â€œå†™é€»è¾‘ã€å†™å¾ªç¯ã€å†™æ¨¡å—â€çš„å°è¯­è¨€ã€‚

---

# ğŸ§  ç›®å½•é¢„è§ˆ

1. æ¡ä»¶è¯­å¥ï¼ˆif / else / endifï¼‰
    
2. å¾ªç¯ä¸ `foreach`
    
3. æ–‡æœ¬å¤„ç†å‡½æ•°ï¼ˆ`patsubst`, `subst`, `wildcard` ç­‰ï¼‰
    
4. æ–‡ä»¶ä¸è·¯å¾„æ“ä½œå‡½æ•°
    
5. `include` ä¸å¤šæ–‡ä»¶ç»„ç»‡
    
6. æ¨¡å—åŒ–å·¥ç¨‹çš„å†™æ³•
    
7. è°ƒè¯•ä¸ä¿¡æ¯è¾“å‡º
    

---

## ğŸ§© ä¸€ã€æ¡ä»¶è¯­å¥ï¼ˆif / else / endifï¼‰

åœ¨ Makefile ä¸­å¯ä»¥å†™é€»è¾‘åˆ¤æ–­ã€‚  
è¯­æ³•ä¸ C ç±»ä¼¼ï¼Œä½†ç”¨å‡½æ•°å¼çš„å†™æ³•ï¼š

```makefile
ifeq ($(DEBUG),1)
    CXXFLAGS += -g -DDEBUG
else
    CXXFLAGS += -O2
endif
```

è§£é‡Šï¼š

- `ifeq (A, B)` â€”â€” å¦‚æœ A ç­‰äº B
    
- `ifneq (A, B)` â€”â€” å¦‚æœ A ä¸ç­‰äº B
    

å¯ä»¥æ§åˆ¶ï¼š

- æ˜¯å¦å¼€å¯è°ƒè¯•
    
- ä¸åŒç³»ç»Ÿä½¿ç”¨ä¸åŒå‘½ä»¤
    
- æ ¹æ®å­˜åœ¨çš„æ–‡ä»¶æ‰§è¡Œä¸åŒé€»è¾‘
    

ğŸ“˜ ä¾‹ï¼š

```makefile
ifeq ($(OS),Windows_NT)
    RM := del
else
    RM := rm -f
endif
```

---

## ğŸ” äºŒã€å¾ªç¯ï¼ˆforeachï¼‰

å¯ä»¥è®©ä½ åœ¨ Makefile é‡Œå†™â€œæ‰¹å¤„ç†å¼â€çš„é€»è¾‘ã€‚  
è¯­æ³•ï¼š

```makefile
$(foreach var, list, expression)
```

ä¾‹ï¼š

```makefile
SRC := main.cpp adder.cpp sub.cpp
all:
	$(foreach f,$(SRC),echo Compiling $(f);)
```

è¾“å‡ºï¼š

```
Compiling main.cpp
Compiling adder.cpp
Compiling sub.cpp
```

ğŸ’¡ æ³¨æ„ï¼š`foreach` åªæ˜¯**å±•å¼€æ–‡æœ¬**ï¼Œä¸ä¼šé€è¡Œæ‰§è¡Œã€‚  
å¦‚æœè¦æ‰§è¡Œ shell å‘½ä»¤ï¼Œè¦åŠ  `;` æˆ–æ”¾åœ¨å‘½ä»¤è¡Œä¸­ã€‚

---

## ğŸ§° ä¸‰ã€æ–‡æœ¬å¤„ç†å‡½æ•°ï¼ˆå­—ç¬¦ä¸²æ“ä½œï¼‰

Make é‡Œæœ€å¸¸ç”¨çš„ä¸€ç±»å‡½æ•°æ˜¯â€œæ–‡æœ¬æ›¿æ¢ä¸è¿‡æ»¤â€ã€‚

|å‡½æ•°|ç”¨é€”|ç¤ºä¾‹|ç»“æœ|
|---|---|---|---|
|`$(subst from,to,text)`|ç®€å•æ›¿æ¢|`$(subst src/,build/,$(SRC))`|æ›¿æ¢è·¯å¾„|
|`$(patsubst pattern,replacement,text)`|æ¨¡å¼æ›¿æ¢|`$(patsubst %.cpp,%.o,$(SRC))`|æ”¹æ‰©å±•å|
|`$(filter pattern,text)`|ä¿ç•™åŒ¹é…çš„|`$(filter %.cpp,$(FILES))`|åªç•™ `.cpp`|
|`$(filter-out pattern,text)`|æ’é™¤åŒ¹é…çš„|`$(filter-out %.txt,$(FILES))`|å»æ‰ `.txt`|
|`$(sort list)`|æ’åºå¹¶å»é‡|`$(sort $(SRC))`|å”¯ä¸€åŒ–|
|`$(wildcard pattern)`|æŸ¥æ‰¾æ–‡ä»¶|`$(wildcard src/*.cpp)`|æ‰€æœ‰ `.cpp`|

---

## ğŸ“ å››ã€æ–‡ä»¶ä¸è·¯å¾„å‡½æ•°

|å‡½æ•°|åŠŸèƒ½|ç¤ºä¾‹|ç»“æœ|
|---|---|---|---|
|`$(dir names)`|å–ç›®å½•éƒ¨åˆ†|`$(dir src/main.cpp)`|`src/`|
|`$(notdir names)`|å–æ–‡ä»¶å|`$(notdir src/main.cpp)`|`main.cpp`|
|`$(basename names)`|å»æ‰æ‰©å±•å|`$(basename main.cpp)`|`main`|
|`$(addprefix prefix,names)`|åŠ å‰ç¼€|`$(addprefix build/,$(FILES))`|`build/main.o`|
|`$(addsuffix suffix,names)`|åŠ åç¼€|`$(addsuffix .o,$(FILES))`|`main.o`|

è¿™äº›å‡½æ•°éå¸¸é€‚åˆå¤„ç†è·¯å¾„æ˜ å°„ã€‚

---

## ğŸ“¦ äº”ã€Include å¤šæ–‡ä»¶ï¼ˆæ¨¡å—åŒ– Makefileï¼‰

åœ¨å¤§é¡¹ç›®ä¸­ï¼Œä¸€ä¸ª Makefile ä¼šè¢«æ‹†æˆå¤šä¸ªå­ Makefileã€‚  
ä¸»æ–‡ä»¶é€šè¿‡ `include` æŠŠå®ƒä»¬åˆå¹¶ã€‚

ç»“æ„ï¼š

```
project/
â”œâ”€â”€ Makefile
â”œâ”€â”€ src/Makefile
â””â”€â”€ test/Makefile
```

ä¸»æ–‡ä»¶ï¼š

```makefile
SUBDIRS := src test
.PHONY: all $(SUBDIRS)

all: $(SUBDIRS)

$(SUBDIRS):
	$(MAKE) -C $@
```

å­ç›®å½•çš„ Makefile å¯ä»¥ä¸“æ³¨è‡ªå·±çš„ç¼–è¯‘é€»è¾‘ã€‚

ğŸ’¡ è¯´æ˜ï¼š

- `$(MAKE)` è°ƒç”¨è‡ªèº«ï¼ˆæ¯”ç›´æ¥å†™ `make` æ›´å®‰å…¨ï¼‰
    
- `-C dir` è¡¨ç¤ºâ€œè¿›å…¥ç›®å½•æ‰§è¡Œâ€
    

---

## âš™ï¸ å…­ã€æ¨¡å¼è§„åˆ™ä¸ order-only ä¾èµ–

ä½ å·²ç»è§è¿‡æ¨¡å¼è§„åˆ™ï¼š

```makefile
%.o: %.cpp
	$(CXX) -c $< -o $@
```

æˆ‘ä»¬è¿˜å¯ä»¥åŠ â€œorder-only ä¾èµ–â€ï¼š

```makefile
build/%.o: src/%.cpp | build
	$(CXX) -c $< -o $@

build:
	mkdir -p build
```

å«ä¹‰ï¼š

> `build` ç›®å½•å¿…é¡»å­˜åœ¨ï¼Œä½†ä¸å‚ä¸é‡æ–°ç¼–è¯‘çš„è§¦å‘ã€‚

å¦‚æœ `build/` ä¸å­˜åœ¨ï¼Œå®ƒä¼šè¢«åˆ›å»ºï¼›  
ä½†ä¿®æ”¹æ—¶é—´ä¸ä¼šå¯¼è‡´é‡æ–°ç¼–è¯‘ `.cpp` æ–‡ä»¶ã€‚

---

## ğŸ§© ä¸ƒã€åŠ¨æ€è§„åˆ™ä¸ eval + callï¼ˆé«˜çº§æŠ€å·§ï¼‰

å½“ä½ éœ€è¦æ ¹æ®å˜é‡ç”Ÿæˆä¸€å¤§æ‰¹è§„åˆ™æ—¶ï¼Œå¯ä»¥ç”¨ `eval` + `call`ã€‚

```makefile
define COMPILE_TEMPLATE
$(1).o: $(1).cpp
	$(CXX) -c $(1).cpp -o $(1).o
endef

SRC := main adder sub
$(foreach f,$(SRC),$(eval $(call COMPILE_TEMPLATE,$(f))))
```

è§£é‡Šï¼š

- `define` â€¦ `endef` å®šä¹‰æ¨¡æ¿ï¼ˆå¸¦å ä½ç¬¦ï¼‰
    
- `$(call name,arg1,...)` è°ƒç”¨æ¨¡æ¿
    
- `$(eval ...)` è®©æ¨¡æ¿ç”Ÿæ•ˆï¼ˆç«‹å³æ‰§è¡Œï¼‰
    

è¿™åœ¨å¤§å‹å·¥ç¨‹è‡ªåŠ¨ç”Ÿæˆè§„åˆ™æ—¶éå¸¸å®ç”¨ã€‚

---

## ğŸ§¾ å…«ã€ä¿¡æ¯è¾“å‡ºä¸è°ƒè¯•æŠ€å·§

Make æä¾›å‡ ä¸ªå‡½æ•°ç”¨äºæ‰“å°è°ƒè¯•ä¿¡æ¯ï¼š

|å‡½æ•°|ç”¨é€”|ç¤ºä¾‹|
|---|---|---|
|`$(info text)`|è¾“å‡ºæç¤ºä¿¡æ¯|`$(info SRC=$(SRC))`|
|`$(warning text)`|è¾“å‡ºè­¦å‘Š|`$(warning Missing header)`|
|`$(error text)`|è¾“å‡ºé”™è¯¯å¹¶ç»ˆæ­¢|`$(error Fatal: missing file)`|

ä¾‹ï¼š

```makefile
$(info Building project...)
$(warning Using default compiler)
$(error No source files found)
```

---

## âœ… ä¹ã€æ€»ç»“æ€ç»´å›¾

|åˆ†ç±»|ä»£è¡¨è¯­æ³•|ç”¨é€”|
|---|---|---|
|æ¡ä»¶|`ifeq`, `ifneq`|æ§åˆ¶ä¸åŒç¼–è¯‘æ¨¡å¼|
|å¾ªç¯|`foreach`, `eval`|æ‰¹é‡ç”Ÿæˆè§„åˆ™|
|å‡½æ•°|`patsubst`, `subst`, `filter`|å­—ç¬¦ä¸²ä¸è·¯å¾„æ“ä½œ|
|include|`include path`|æ¨¡å—åŒ–ç®¡ç†|
|æ¨¡å¼|`%.o: %.cpp`|é€šç”¨è§„åˆ™|
|è°ƒè¯•|`info`, `warning`, `error`|æ‰“å°å’ŒæŠ¥é”™|

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä»¬å¯ä»¥**ä¸‹ä¸€æ­¥åŠ¨æ‰‹å†™ä¸€ä¸ªâ€œå¸¦è°ƒè¯•æ¨¡å¼ + å¤šç›®å½•ç»“æ„ + è‡ªåŠ¨ä¾èµ–â€çš„å®æˆ˜é¡¹ç›® Makefile**ï¼Œ  
å®ƒä¼šç»¼åˆè¿ç”¨è¿™äº›é«˜çº§è¯­æ³•ã€‚

è¦æˆ‘å¸®ä½ ä¸€æ­¥æ­¥å†™é‚£ä¸ªé¡¹ç›®å—ï¼Ÿ